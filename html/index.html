<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.min.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.25.0/codemirror.min.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/froala-editor/2.7.1/css/froala_editor.pkgd.min.css" rel="stylesheet" type="text/css" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/froala-editor/2.7.1/css/froala_style.min.css" rel="stylesheet" type="text/css" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/froala-editor/2.7.1/css/themes/dark.min.css" rel="stylesheet" type="text/css" />
  </head>

  <body>
	<style>
		html, body, .parent {
			width: 100%;
			height: 100%;
			margin: 0;
			padding: 0;
		}
		.parent {
			display: flex;
		}
		.child {
			width: 50%;
			height: 100%;
			max-width: 59%;
			max-height: 100%;
			margin: 0;
		}
		.child .fr-box {
			height: 100%;
			max-height: 100%;
		}
		.child .fr-wrapper {
			overflow-y: scroll;
		}
	</style>

	<div class="parent">
		<div class="child"><textarea></textarea></div>
		<object class="child" type="application/pdf"></object>
	</div>

    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.25.0/codemirror.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.25.0/mode/xml/xml.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/froala-editor/2.7.1/js/froala_editor.pkgd.min.js"></script>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/extjs/6.2.0/ext-modern-all.js"></script>
	<script>
		var saveKey = 'htmlbody';
		var timer = null;

		var resizeFn = function ( ) {
			var container = $( '.child .fr-wrapper' );
			container.css( 'height', window.innerHeight - container.offset( ).top )
		};
		var getAndSetPDF = function ( html ) {
			$( 'object' ).attr( 'data', '' );
			Ext.Ajax.request( {
				method: 'post',
				url: 'gen',
				binary: true,
				rawData: html,
				callback: function ( ) {
					timer = null
				},
				success: function ( result ) {
					var blob = new Blob( [ result.responseBytes ], {
						type: 'application/pdf'
					} )
					var fileReader = new FileReader( );
					fileReader.onload = function ( ) {
						var dataURI = fileReader.result;
						$( 'object' ).attr( 'data', dataURI );
					};
					fileReader.readAsDataURL( blob );
				}
			} );
		};
		var onChangeBody = function ( e, editor ) {
			window.localStorage.setItem( saveKey, editor.html.get( ) )
			if ( timer ) {
				clearTimeout( timer )
			}
			timer = setTimeout( function ( ) {
				var html = editor.html.get( )
				getAndSetPDF( html );
			}, 1000 );
		};
		var init = function ( ) {
			// INFO:
			// Be careful to an order of these functions
			var firstContent = window.localStorage.getItem( saveKey );
			$( 'textarea' ).html( firstContent );
			getAndSetPDF( firstContent );

			$( 'textarea' ).froalaEditor( {
				theme: 'dark'
			} )
			$( 'window' ).on( 'load resize', resizeFn )
			resizeFn( );
			$( 'textarea' ).on( 'froalaEditor.contentChanged', onChangeBody );
			$( 'textarea' ).on( 'froalaEditor.input', onChangeBody );
		};

		init( );

	</script>
  </body>
</html>
